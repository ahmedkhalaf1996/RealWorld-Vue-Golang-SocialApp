name: Frontend Integration E2E Testing 

on: 
  workflow_call:

jobs:
  integration-tests:
    name: Frontend Integration Tests (with Backend)
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7.0
        ports: 
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7.0-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5      

    steps:
      - uses: actions/checkout@v4

      - name: Setup Backend Environment
        uses: ./.github/actions/setup-backend

      - name: Setup Frontend Environment
        uses: ./.github/actions/setup-frontend     

      - name: Wait For MongoDB To be ready
        run: |
          until nc -z localhost 27017; do 
            echo "Waiting For MongoDB..."
            sleep 2 
          done 
          echo "MongoDB is Ready!"

      - name: Wait For Redis To be ready
        run: |
          until nc -z localhost 6379; do 
            echo "Waiting For Redis..."
            sleep 2 
          done 
          echo "Redis is Ready!"
      
      # Start backend api in background 
      - name: Start Backend API 
        run: |
          echo "Starting backend server.."
          go run ./cmd &
          echo $! > backend.pid
          sleep 10 
          echo "Backend process started with PID: $(cat backend.pid)"
        working-directory: ./backend/api 
        env:
          MONGODB_URI: mongodb://localhost:27017 
          REDIS_URL: localhost:6379
          REDIS_PASSWORD: ""
          PORT: 5000 
        
      # Wait for backend to be ready
      - name: Wait For backend API 
        run: |
          echo "Waiting for backend on port 5000.."
          timeout 60 bash -c 'until nc -z localhost 5000; do echo "Waiting for backend..."; sleep 2; done'
          echo "Backend port is open, testing http response..."
          timeout 30 bash -c 'until curl -f http://localhost:5000 2>/dev/null; do echo "Waiting for http response.."; sleep 2; done'
          echo "Backend API is ready!"

      # Start Frontend in background (using port 8080 instead of 80 to avoid sudo issues)
      - name: Start Frontend in background
        run: |
          echo "Starting Frontend application on port 8080.."
          nohup npm run serve -- --port 8080 > frontend.log 2>&1 &
          echo $! > frontend.pid 
          sleep 15
          echo "Frontend process started with PID: $(cat frontend.pid)"
          if pgrep -f "vue-cli-service serve" > /dev/null; then 
            echo "Vue CLI service is running"
          else 
            echo "Vue CLI service not found, checking logs:"
            cat frontend.log || echo "No log file found"
            exit 1
          fi 
        working-directory: ./frontend 
        env:
          VUE_APP_API_URL: http://localhost:5000 
        
      # Wait for frontend to be ready
      - name: Wait For frontend application 
        run: |
          echo "Waiting for frontend on port 8080.."
          timeout 60 bash -c 'until nc -z localhost 8080; do echo "Waiting for frontend..."; sleep 2; done'
          echo "Frontend port is open, testing http response..."
          timeout 30 bash -c 'until curl -f http://localhost:8080 2>/dev/null; do echo "Waiting for http response.."; sleep 2; done'
          echo "Frontend application is ready!"  
        working-directory: ./frontend   

      - name: Show Frontend Logs (if wait fails)
        if: failure()
        run: |
          echo "=== Frontend Logs ==="
          cat frontend.log || echo "No frontend log file found"
          echo "=== Process Status ==="
          ps aux | grep -E 'vue-cli-service|node' || echo "No relevant processes found"
        working-directory: ./frontend

      - name: Run Cypress Integration Tests 
        run: npm run cy:run:auth 
        working-directory: ./frontend 
        env:
          CYPRESS_BASE_URL: http://localhost:8080
          CYPRESS_API_URL: http://localhost:5000

      - name: Stop Applications 
        if: always()
        run: |
          if [ -f ./backend/api/backend.pid ]; then
            kill $(cat ./backend/api/backend.pid) || true 
          fi 
          if [ -f ./frontend/frontend.pid ]; then
            kill $(cat ./frontend/frontend.pid) || true 
          fi 
          sudo lsof -ti:5000 | xargs -r sudo kill -9 || true 
          sudo lsof -ti:8080 | xargs -r sudo kill -9 || true